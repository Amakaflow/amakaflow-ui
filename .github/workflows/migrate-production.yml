# Automated Supabase Migration for Production
# Manual trigger only - requires explicit approval to run
#
# Required secrets:
#   - SUPABASE_ACCESS_TOKEN: Personal access token from supabase.com/dashboard/account/tokens
#   - SUPABASE_DB_PASSWORD_PROD: Database password for production project
#   - SUPABASE_PROJECT_REF_PROD: Production project reference ID
#
# Usage:
#   1. Go to Actions tab in GitHub
#   2. Select "Migrate Production Database"
#   3. Click "Run workflow"
#   4. Confirm and run

name: Migrate Production Database

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "production" to confirm'
        required: true
        type: string

jobs:
  migrate:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'production' }}

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD_PROD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify secrets are configured
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "‚ùå SUPABASE_ACCESS_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "‚ùå SUPABASE_DB_PASSWORD_PROD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SUPABASE_PROJECT_REF_PROD }}" ]; then
            echo "‚ùå SUPABASE_PROJECT_REF_PROD secret is not set"
            exit 1
          fi
          echo "‚úÖ Required secrets are configured"

      - name: Link Supabase project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF_PROD }}

      - name: Push migrations to production
        run: |
          echo "üöÄ Pushing migrations to PRODUCTION database..."
          supabase db push
          echo "‚úÖ Production migrations applied successfully"

      - name: Show migration status
        run: |
          echo "üìã Current migration status:"
          supabase migration list

  rejected:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm != 'production' }}
    steps:
      - name: Rejected
        run: |
          echo "‚ùå Migration rejected - you must type 'production' to confirm"
          exit 1
