name: Claude Code Review

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

# Cancel any in-progress review for the same PR when a new push arrives.
# This prevents the 53-comment spam problem.
concurrency:
  group: code-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  code-review:
    # Skip drafts and skip pushes made by github-actions[bot] (auto-fix commits)
    # to avoid infinite re-trigger loops.
    if: |
      !github.event.pull_request.draft &&
      github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Dismiss stale bot reviews
        uses: actions/github-script@v7
        with:
          script: |
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            for (const review of reviews.data) {
              if (review.user.login === 'github-actions[bot]' &&
                  (review.state === 'CHANGES_REQUESTED' || review.state === 'APPROVED')) {
                await github.rest.pulls.dismissReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.payload.pull_request.number,
                  review_id: review.id,
                  message: 'Dismissed: new review in progress.'
                });
              }
            }

      - uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ""
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_sticky_comment: true
          claude_args: '--allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api:*),Bash(git fetch:*),Bash(git checkout:*),Bash(git config:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git status:*)"'
          prompt: |
            You are a senior code reviewer for the AmakaFlow Python backend monorepo.
            The repo contains multiple FastAPI services under services/. Your audience is a junior developer — be specific and actionable.

            First, use `gh pr diff` to review the changes. Identify which service(s) are affected.
            Then review this PR thoroughly for:

            1. **Critical issues**: Runtime errors, crashes, incorrect function signatures, data loss
            2. **Security**: Auth gaps, injection, input validation, secrets exposure
            3. **Error handling**: Consistent use of HTTPException, specific exception types
            4. **API design**: REST conventions, response models, OpenAPI docs
            5. **FastAPI best practices**: async/sync correctness, Depends usage, Pydantic models
            6. **Cross-service concerns**: If changes affect inter-service contracts, flag both sides
            7. **Code quality**: DRY violations, unused code, type safety

            ## Output format

            Structure your review EXACTLY like this:

            ### Verdict
            State one of: **Approved**, **Approved with comments**, or **Changes required**

            ### Issues found
            List each issue with:
            - Severity (Critical / Important / Minor / Nitpick)
            - File and line number
            - What's wrong (1 sentence)
            - How to fix it (specific code or steps)

            ### Action items
            A numbered checklist of EXACTLY what the developer needs to do, in order.
            If there are no issues: "No action needed — this PR is ready to merge."

            ## Self-healing mode

            If you find **Critical or Important** issues, fix them directly:

            1. Get the branch: `BRANCH=$(gh pr view --json headRefName --jq .headRefName)`
            2. Fetch and switch: `git fetch origin "$BRANCH" && git checkout "$BRANCH"`
            3. Fix the issues.
            4. Configure git identity:
               ```
               git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
               git config user.name "github-actions[bot]"
               ```
            5. Commit: `git add -A && git commit -m "fix: address review issues — <brief summary>"`
            6. Push: `git push origin "$BRANCH"`

            Only use CHANGES_REQUESTED if the fix requires an architectural decision or would change feature behaviour.

            ## Submitting the review

            IMPORTANT: After writing your review comment, you MUST submit a formal GitHub PR review.
            Use APPROVE when verdict is Approved or Approved with comments.
            Use CHANGES_REQUESTED only when architectural changes are needed.

            ```bash
            PR_NUM=$(gh pr view --json number --jq .number)
            VERDICT="APPROVE"  # or CHANGES_REQUESTED
            gh api repos/$GITHUB_REPOSITORY/pulls/$PR_NUM/reviews \
              -f event="$VERDICT" \
              -f body="Review verdict: see sticky comment above."
            ```
