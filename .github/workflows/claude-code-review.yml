name: Claude Code Review

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  code-review:
    if: github.event.pull_request.user.login == 'openclawjoshua-eng' && !github.event.pull_request.draft
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Dismiss stale reviews
        uses: actions/github-script@v7
        with:
          script: |
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            for (const review of reviews.data) {
              if (review.user.login === 'github-actions[bot]' && review.state === 'CHANGES_REQUESTED') {
                await github.rest.pulls.dismissReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  review_id: review.id,
                  message: 'Dismissed: new review in progress.'
                });
              }
            }

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_sticky_comment: true
          claude_args: '--allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api:*)"'
          prompt: |
            You are a senior code reviewer for a React TypeScript web application (amakaflow-ui).
            Stack: Vite, React 18, TypeScript, Tailwind CSS v4, Radix UI, Vitest.
            Your audience is a junior developer — be specific and actionable.

            First, use `gh pr diff` to review the changes. Then review this PR thoroughly for:

            1. **Critical issues**: Runtime errors, crashes, incorrect props/types, data loss
            2. **Security**: XSS, dangerouslySetInnerHTML, unescaped user input, secrets exposure
            3. **React patterns**: Hook rules, unnecessary re-renders, missing deps in useEffect, key props
            4. **TypeScript**: Proper typing, no `any` escape hatches, discriminated unions
            5. **Component design**: Single responsibility, proper prop interfaces, accessible markup
            6. **Code quality**: DRY violations, unused imports/variables, naming clarity

            ## Output format

            Structure your review EXACTLY like this:

            ### Verdict
            State one of: **Approved**, **Approved with comments**, or **Changes required**

            ### Issues found
            List each issue with:
            - Severity (Critical / Important / Minor / Nitpick)
            - File and line number
            - What's wrong (1 sentence)
            - How to fix it (specific code or steps)

            ### Action items
            A numbered checklist of EXACTLY what the developer needs to do, in order.
            Be specific — include file names, line numbers, and what to change.
            For example:
            1. In `src/components/Panel.tsx:42`, add missing `key` prop to the mapped list items
            2. In `src/hooks/useData.ts:15`, add `fetchData` to the useEffect dependency array
            3. Push your changes — CI and code review will re-run automatically

            If there are no issues, just say: "No action needed — this PR is ready to merge."

            ## Submitting the review

            After writing your review, submit a formal PR review using the GitHub API:
            - If there are ANY Critical issues: submit with event "REQUEST_CHANGES"
            - If there are only Important/Minor/Nitpick issues: submit with event "COMMENT"
            - If there are no issues: submit with event "APPROVE"

            Use this command to submit the formal review:
            ```
            gh api repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/reviews \
              -f event="REQUEST_CHANGES" \
              -f body="Review verdict: **Request changes** — see action items in review comment."
            ```
            Replace the event and body as appropriate for COMMENT or APPROVE verdicts.
            Get the PR number from `gh pr view --json number --jq .number`.
